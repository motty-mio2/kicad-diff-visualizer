<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>KiCad PCB Diff</title>
<style>

.commit {
  border-left: 4px solid #4CAF50;
  background-color: #fff;
  margin-bottom: 14px;
  padding: 10px 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.commit:hover {
  background-color: #cce5ff;
}

.commit.hash {
  font-weight: bold;
  color: #444;
}

.commit .refs {
  font-size: small;
  color: #444;
}

.message {
  margin: 8px 0;
}
footer.meta {
  font-size: 0.85em;
  color: #777;
}

button.apply {
  background-color: #2ea44f;
  color: #fff;
  border: 1px solid;
  border-radius: 6px;
  padding: 5px;
}

button.show-option {
  margin-right: 1em;
}

#pcb-image-div {
  overflow: hidden;  // 枠からはみ出た部分を表示しない
  box-sizing: border-box;  // スクロールバー出現防止
  margin-top: 2px;
  border: 1px solid #2ea44f;
}

#img-load-progress {
  position: absolute;
  margin-top: 100px;
  left: 10%;
}

</style>
</head>
<body>

<fieldset id="commit-set">
<legend>Select commit/backup:</legend>

{% set mode_conf = {
    'base': {
        'title': 'Base (old commit)',
        'commit_id': base_commit_id,
        'select_option_handler': 'selectBaseOption(this)',
    },
    'target': {
        'title': 'Target (new commit)',
        'commit_id': target_commit_id,
        'select_option_handler': 'selectTargetOption(this)',
    },
} %}

{% for mode, conf in mode_conf.items() %}
  <label for="{{mode}}-commit">{{conf['title']}}:</label>
  <input type="text" id="{{mode}}-commit" size="7"
  placeholder="input or choose"
  value="{{conf['commit_id']}}" />

  <button command="show-modal" commandfor="{{mode}}-options" class="show-option">show list</button>
  <dialog id="{{mode}}-options" onclick="closeDialog(this)">
    <article class="commit" onclick="{{conf['select_option_handler']}}" data-commit-id="WORK">
      <header class="hash">WORK</header>
      <p class="message">Working tree</header>
    </article>
    {% for cl in commit_logs %}
    <article class="commit" onclick="{{conf['select_option_handler']}}" data-commit-id="{{cl.hash}}">
      <header>
        commit
        <code class="hash">{{cl.hash}}</code>
        <span class="refs">{% if cl.refs != '' %}({{cl.refs}}){% endif %}</span></header>
      <p class="message">{{cl.subject}}</p>
      <p class="message">{{cl.body}}</p>
      <footer class="meta">Author: {{cl.author_name}} | Date: {{cl.author_date}}</footer>
    </article>
    {% endfor %}
    {% for bv in backup_versions %}
    <article class="commit" onclick="{{conf['select_option_handler']}}" data-commit-id="{{bv}}">
      <header>backup {{bv}}</header>
    </article>
    {% endfor %}
    <ul>
    </ul>
  </dialog>
{% endfor %}

<button id="change-commit-button" class="apply">Apply commit setting</button>

</fieldset>

<div class="fieldset-wrapper" style="display: flex;">

  <fieldset id="imagesel-set" disabled>
    <legend>Select image:</legend>

    <select id="layer-select">
      {% for l in obj_list %}
      <option value="{{l}}" {% if l == layer %}selected{% endif %}>{{l}}</option>
      {% endfor %}
    </select>

    <input type="radio" name="imagesel" id="show-both" value="show-both" checked />
    <label for="show-both">Both</label>

    <input type="radio" name="imagesel" id="show-base" value="show-base" />
    <label for="show-base">Base</label>

    <input type="radio" name="imagesel" id="show-target" value="show-target" />
    <label for="show-target">Target</label>

    {% if mode == 'pcb' %}
    <input type="checkbox" id="fit-board" onchange="jumpToSelectedLayer()" {% if fit_board %}checked{% endif %} />
    <label for="fit-board">Fit</label>
    {% endif %}
  </fieldset>

  <fieldset id="vm-set" disabled>
    Scale:
    <span id="svg-zoom-pct">100</span>
    <span>%</span>

    <button id="reset-zoom" onclick="resetZoom()">Reset</button>

    <legend>Visualization mode:</legend>

    <input type="radio" name="visualmode" id="vm-diff" value="vm-diff" checked />
    <label for="vm-diff">Diff</label>

    <input type="radio" name="visualmode" id="vm-overlay" value="vm-overlay" />
    <label for="vm-overlay">Overlay</label>

    <input type="radio" name="visualmode" id="vm-blend" value="vm-blend" />
    <label for="vm-blend">Blend</label>
  </fieldset>

</div>

<progress id="img-load-progress" aria-label="loading an SVG image...">
</progress>

<div id="pcb-image-div" aria-busy="true" aria-describedby="img-load-progress">
</div>

<script>


function zoomToScale(zoom) {
  // 拡大縮小の範囲を制限する
  const zoom_limited = Math.min(Math.max(zoom, 0.1), 5);
  return Math.pow(2, zoom_limited - 1);
}

let current_zoom = {{ current_zoom }};

let scale = zoomToScale(current_zoom);
let trans_x = {{ trans_x }};
let trans_y = {{ trans_y }};

function applyTransform(overlayed_svg) {
  overlayed_svg.style.transform = `translate(${trans_x}px, ${trans_y}px) scale(${scale})`;
  document.getElementById("svg-zoom-pct").textContent = (scale * 100).toFixed(0);
}

function zoomImage(new_zoom, origin_x, origin_y) {
  const zoom = Math.min(Math.max(new_zoom, 0.1), 5);

  // 画像は遅延読み込みなので、ここで取得
  const overlayed_svg = document.getElementById("overlayed_svg");

  const prev_scale = scale;
  scale = zoomToScale(zoom);

  trans_x -= (origin_x / prev_scale) * (scale - prev_scale);
  trans_y -= (origin_y / prev_scale) * (scale - prev_scale);

  applyTransform(overlayed_svg);

  current_zoom = zoom;
}

function resetZoom() {
  const overlayed_svg = document.getElementById("overlayed_svg");
  if (!overlayed_svg) {
    return;
  }
  current_zoom = 1;
  scale = 1;
  trans_x = 0;
  trans_y = 0;
  applyTransform(overlayed_svg);
}

const layer_select = document.getElementById("layer-select");
const fit_board = document.getElementById("fit-board");

document.getElementById("layer-select").addEventListener("change", (event) => {
  jumpToSelectedLayer();
});


const base_commit = document.getElementById("base-commit");
const target_commit = document.getElementById("target-commit");

function jsonToQueryString(json) {
  const qs = Object.keys(json)
    .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(json[key])}`)
    .join("&");
  return qs ? "?" + qs : "";
}

function jumpToSelectedLayer() {
  const query = jsonToQueryString({
    fit_board: fit_board ? fit_board.checked : false,
    trans_x: trans_x,
    trans_y: trans_y,
    zoom: current_zoom
  });
  const selected_layer = layer_select.value;
  const base_commit_id = base_commit.value;
  const target_commit_id = target_commit.value;
  window.location.href = `/diff/${base_commit_id}/${target_commit_id}/${selected_layer}${query}`;
}

document.getElementById("change-commit-button").addEventListener("click", (event) => {
  jumpToSelectedLayer();
});

const base_options = document.getElementById("base-options");
const target_options = document.getElementById("target-options");

function closeDialog(el) {
  const rect = el.getBoundingClientRect();
  const clickedOutside =
    event.clientX < rect.left ||
    event.clientX > rect.right ||
    event.clientY < rect.top ||
    event.clientY > rect.bottom;

  if (clickedOutside) {
    el.close();
  }
};

function selectBaseOption(el) {
  base_commit.value = el.dataset.commitId;
  base_options.close();
}

function selectTargetOption(el) {
  target_commit.value = el.dataset.commitId;
  target_options.close();
}

let last_wheel_time = 0;
let wheel_buffer = [];

function detect_device_type(mouse_event) {
  const delta_time = mouse_event.timeStamp - last_wheel_time;
  last_wheel_time = mouse_event.timeStamp;

  wheel_buffer.push({ deltaY: mouse_event.deltaY, delta_time: delta_time });
  if (wheel_buffer.length > 10) {
    wheel_buffer.shift();
  }

  const is_fast_wheel = wheel_buffer.filter(
    elem => elem.delta_time < 30 && Math.abs(elem.deltaY) < 15
  ).length > 5;

  if (is_fast_wheel) {
    return "trackpad";
  } else {
    return "mouse";
  }
}

const pcb_image_div = document.getElementById("pcb-image-div");

function adjust_pcb_image_height() {
  const pcb_image_top = pcb_image_div.getBoundingClientRect().top;
  const pcb_image_height = window.innerHeight - pcb_image_top - 10;

  pcb_image_div.style.width = "100%";
  pcb_image_div.style.height = `${pcb_image_height}px`;
}

window.addEventListener("resize", adjust_pcb_image_height);
window.addEventListener("load", adjust_pcb_image_height);

function onload_pcb_image(svg_text) {
  console.log("pcb image loaded");
  pcb_image_div.innerHTML = svg_text;
  pcb_image_div.setAttribute("aria-busy", "false");
  document.getElementById("img-load-progress").style.display = "none";

  const overlayed_svg = document.getElementById("overlayed_svg");
  console.log(overlayed_svg);

  const bottom_g = document.getElementById("bottom-g");
  const top_g = document.getElementById("top-g");

  document.getElementById("show-base").addEventListener("change", (event) => {
    if (event.srcElement.checked) {
      bottom_g.style.opacity = 1;
      top_g.style.opacity = 0;
    }
  });
  document.getElementById("show-target").addEventListener("change", (event) => {
    if (event.srcElement.checked) {
      bottom_g.style.opacity = 0;
      top_g.style.opacity = 1;
    }
  });
  document.getElementById("show-both").addEventListener("change", (event) => {
    if (event.srcElement.checked) {
      bottom_g.style.opacity = 1;
      top_g.style.opacity = 1;
    }
  });

  document.getElementById("vm-diff").addEventListener("change", (event) => {
    if (event.srcElement.checked) {
      top_g.style.mixBlendMode = "screen";
      top_g.style.opacity = 1;
    }
  });
  document.getElementById("vm-overlay").addEventListener("change", (event) => {
    if (event.srcElement.checked) {
      top_g.style.mixBlendMode = "normal";
      top_g.style.opacity = 1;
    }
  });
  document.getElementById("vm-blend").addEventListener("change", (event) => {
    if (event.srcElement.checked) {
      top_g.style.mixBlendMode = "normal";
      top_g.style.opacity = 0.8;
    }
  });

  ["imagesel-set", "vm-set"].forEach(id => {
    document.getElementById(id).removeAttribute("disabled");
  });

  overlayed_svg.style.transformOrigin = "0 0";

  applyTransform(overlayed_svg);
  console.log("initial transform applied", {{ current_zoom }}, "trans", {{ trans_x }}, {{ trans_y }});

  overlayed_svg.addEventListener('wheel', (event) => {
    event.preventDefault();  // ページ全体のズームを防止

    // マウス座標から画像内座標へ変換
    const img_rect = overlayed_svg.getBoundingClientRect();
    const origin_x = event.clientX - img_rect.left;
    const origin_y = event.clientY - img_rect.top;

    let delta_y = event.deltaY;
    let device_type = detect_device_type(event);
    console.log("device type", device_type);
    switch (event.deltaMode) {
      case 0: // px
        switch (device_type) {
          case "trackpad":
            delta_y /= 3;
            break;
          default:
            delta_y /= 30;
            break;
        }
      case 1: // line
        delta_y /= 3;
        break;
      case 2: // page
        break;
    }

    const zoom_delta = (-delta_y) * 0.2;
    console.log("zoom_delta:", zoom_delta);

    zoomImage(current_zoom + zoom_delta, origin_x, origin_y);
  });

  let is_dragging = false;
  overlayed_svg.addEventListener("mousedown", (event) => {
    is_dragging = true;
    overlayed_svg.style.cursor = "grabbing";
  });
  overlayed_svg.addEventListener("mouseup", (event) => {
    is_dragging = false;
    overlayed_svg.style.cursor = "default";
  });

  overlayed_svg.addEventListener("mousemove", (event) => {
    if (!is_dragging) {
      return;
    }

    trans_x += event.movementX;
    trans_y += event.movementY;
    applyTransform(overlayed_svg);
  });
}

const pcb_image_path = (`/image/{{base_commit_id}}/{{target_commit_id}}/{{layer}}.svg` +
  `?fit_board=${fit_board ? fit_board.checked : false}`);
fetch(pcb_image_path)
  .then(res => res.text())
  .then(svg_text => onload_pcb_image(svg_text));

</script>
</body>
</html>
